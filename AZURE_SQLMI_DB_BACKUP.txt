

--ENCRYPTION NEEDS TO BE TURNED OFF BEFORE ATTEMPTING TO BACK UP DATABASE ON SQLMI


USE [master]
GO
ALTER DATABASE [spc_dba_utilities] SET ENCRYPTION OFF
GO


--DECRYPTION PROCESS MUST COMPLETE BEFORE BACKUP CAN PROCEED (RETRY LOGIC IN SQL AGENT)


--DROP THE DEK AFTER DECRYPTION

USE [spc_dba_utilities]
GO
DROP DATABASE ENCRYPTION KEY
GO


--BACK UP THE DATABASE TO BLOB STORAGE WITH GENERIC FILE NAME


BACKUP DATABASE [spc_dba_utilities] 
TO  URL = N'https://dbanonprod.blob.core.usgovcloudapi.net/backuptest/spc_dba_utilities_TEST_PROD_backup.bak' 
WITH  BLOCKSIZE = 65536
, MAXTRANSFERSIZE = 4194304
, COPY_ONLY
, FORMAT --overwrite existing backup files with the same name
, NOREWIND
, NOUNLOAD
, COMPRESSION
, STATS = 10
GO


--SAS TOKEN FOR THIS CREDENTIAL (URL) WAS GENERATED WITH READ / WRITE / LIST / MODIFY / DELETE PERMS.
--THIS MUST BE PERFORMED WITHIN AZURE PORTAL.  
--NEGLECTING TO GRANT CORRECT PERMS WILL GIVE GENERIC ERROR WHEN TRYING TO BACK UP DATABASE
--SAS TOKEN EXPIRES MARCH 2027



--RE-ENCRYPT DATABASE UPON COMPLETION

USE [master]
GO
ALTER DATABASE [spc_dba_utilities] SET ENCRYPTION ON
GO



