--CHECK DATABASE ENCRYPTION STATUS

SELECT
    db.name,
    db.is_encrypted,
    dm.encryption_state,
    dm.percent_complete,
    dm.key_algorithm,
    dm.key_length
FROM
    sys.databases db
    LEFT OUTER JOIN sys.dm_database_encryption_keys dm
        ON db.database_id = dm.database_id;
GO


--ENCRYPTION NEEDS TO BE TURNED OFF BEFORE ATTEMPTING TO BACK UP DATABASE ON SQLMI


USE [master]
GO
ALTER DATABASE [spc_dba_utilities] SET ENCRYPTION OFF
GO


--DECRYPTION PROCESS MUST COMPLETE BEFORE BACKUP CAN PROCEED (RETRY LOGIC IN SQL AGENT)


--DROP THE DEK AFTER DECRYPTION

USE [AS_BUILT]
GO
DROP DATABASE ENCRYPTION KEY
GO


--IF NECESSARY, VERIFY THAT THE BLOB STORAGE SAS CREDENTIAL EXISTS FOR THE INSTANCE YOU ARE PERFORMING THE BACKUP FROM:

select * from sys.credentials;

--IF NOT, ADD IT:  (the "SECRET" string shows the expiration date, the permissions, etc.)

CREATE CREDENTIAL [https://dbanonprod.blob.core.usgovcloudapi.net/backuptest]
WITH IDENTITY = 'SHARED ACCESS SIGNATURE',
SECRET = 'sp=racwdl&st=2024-07-15T22:51:06Z&se=2027-07-16T06:51:06Z&spr=https&sv=2022-11-02&sr=c&sig=ThDe2zhvwjYZKSVcEP3wVApbPbPyhyB2%2FRZAcBBfwRg%3D'
GO

--IF ALTERING AN EXISTING SAS CREDENTIAL, CHANGE THE CREATE STATEMENT ABOVE TO ALTER


--BACK UP THE DATABASE TO BLOB STORAGE WITH GENERIC FILE NAME


BACKUP DATABASE [AS_BUILT] 
TO  URL = N'https://dbanonprod.blob.core.usgovcloudapi.net/backuptest/AS_BUILT_UAT_VALIDATION.bak' 
WITH  BLOCKSIZE = 65536
, MAXTRANSFERSIZE = 4194304
, COPY_ONLY
, FORMAT --overwrite existing backup files with the same name
, NOREWIND
, NOUNLOAD
, COMPRESSION
, STATS = 10
GO


--SAS TOKEN FOR THIS CREDENTIAL (URL) WAS GENERATED WITH READ / WRITE / LIST / MODIFY / DELETE PERMS.
--THIS MUST BE PERFORMED WITHIN AZURE PORTAL.  
--NEGLECTING TO GRANT CORRECT PERMS WILL GIVE GENERIC ERROR WHEN TRYING TO BACK UP DATABASE
--SAS TOKEN EXPIRES MARCH 2027



--RE-ENCRYPT DATABASE UPON COMPLETION

USE [master]
GO
ALTER DATABASE [spc_dba_utilities] SET ENCRYPTION ON
GO



