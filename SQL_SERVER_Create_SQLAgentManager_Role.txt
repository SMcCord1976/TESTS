USE [master];
GO

-- Create the custom server-level role
CREATE SERVER ROLE SQLAgentManager;
GO

-- Grant VIEW SERVER STATE for viewing job execution status
GRANT VIEW SERVER STATE TO SQLAgentManager;
GO

-- Add the server role as a user in msdb
USE [msdb];
GO
IF NOT EXISTS (SELECT * FROM sys.database_principals WHERE name = 'SQLAgentManager')
BEGIN
    CREATE USER [SQLAgentManager] FOR SERVER ROLE [SQLAgentManager];
END
GO

-- Grant SQL Server Agent Operator Role for broad job management
EXEC sp_addrolemember @rolename = 'SQLAgentOperatorRole', @membername = 'SQLAgentManager';
GO

-- Grant additional permissions for full job, schedule, operator, and alert management
GRANT EXECUTE ON msdb.dbo.sp_add_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_start_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_stop_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_add_jobschedule TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_jobschedule TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_jobschedule TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_add_jobstep TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_jobstep TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_jobstep TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_help_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_help_jobhistory TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_add_alert TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_alert TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_alert TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_add_operator TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_operator TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_operator TO SQLAgentManager;
GO

-- Grant SELECT permissions on system tables for viewing job details
GRANT SELECT ON msdb.dbo.sysjobs TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysjobsteps TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysjobschedules TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysjobhistory TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysalerts TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysoperators TO SQLAgentManager;
GO

-- Return to master database
USE [master];
GO

-- Example: Assign the role to a login (replace 'YourLoginName' with the actual login)
-- ALTER SERVER ROLE SQLAgentManager ADD MEMBER YourLoginName;
-- GO

-- Verify the role permissions
SELECT * FROM sys.server_permissions WHERE grantee_principal_id = SUSER_SID('SQLAgentManager');
SELECT * FROM msdb.sys.database_permissions WHERE grantee_principal_id = USER_ID('SQLAgentManager');
SELECT * FROM msdb.sys.database_role_members WHERE member_principal_id = USER_ID('SQLAgentManager');
GO