USE [master];
GO

-- Create the custom server-level role
CREATE SERVER ROLE SQLAgentManager;
GO

-- Grant server-level permissions for SQL Server Agent management
GRANT ALTER ANY AGENT JOB TO SQLAgentManager;
GRANT CREATE ANY AGENT JOB TO SQLAgentManager;
GRANT EXECUTE ANY AGENT JOB TO SQLAgentManager;
GRANT VIEW ANY AGENT JOB TO SQLAgentManager;
GRANT ALTER ANY AGENT SCHEDULE TO SQLAgentManager;
GRANT CREATE ANY AGENT SCHEDULE TO SQLAgentManager;
GRANT VIEW ANY AGENT SCHEDULE TO SQLAgentManager;
GRANT ALTER ANY AGENT OPERATOR TO SQLAgentManager;
GRANT CREATE ANY AGENT OPERATOR TO SQLAgentManager;
GRANT VIEW ANY AGENT OPERATOR TO SQLAgentManager;
GRANT VIEW SERVER STATE TO SQLAgentManager; -- Required to view job execution status and history

-- Grant access to SQL Server Agent system stored procedures
GRANT EXECUTE ON msdb.dbo.sp_add_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_start_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_stop_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_add_jobschedule TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_jobschedule TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_jobschedule TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_add_jobstep TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_jobstep TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_jobstep TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_help_job TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_help_jobhistory TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_add_alert TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_alert TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_alert TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_add_operator TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_delete_operator TO SQLAgentManager;
GRANT EXECUTE ON msdb.dbo.sp_update_operator TO SQLAgentManager;

-- Grant SELECT permissions on SQL Server Agent system tables for viewing job details
GRANT SELECT ON msdb.dbo.sysjobs TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysjobsteps TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysjobschedules TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysjobhistory TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysalerts TO SQLAgentManager;
GRANT SELECT ON msdb.dbo.sysoperators TO SQLAgentManager;

-- Example: Assign the role to a login (replace 'YourLoginName' with the actual login)
-- ALTER SERVER ROLE SQLAgentManager ADD MEMBER YourLoginName;
-- GO

-- Optional: Verify the role permissions
SELECT * FROM sys.server_permissions WHERE grantee_principal_id = SUSER_SID('SQLAgentManager');
SELECT * FROM sys.server_role_members WHERE role_principal_id = SUSER_SID('SQLAgentManager');
GO